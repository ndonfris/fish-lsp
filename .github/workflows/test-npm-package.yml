## Test that the built npm package can be successfully installed and works correctly
## This workflow builds the package, packs it, installs it globally, and runs verification commands
name: Test NPM Package Installation

on:
  workflow_dispatch: # Allow manual triggering
  pull_request:
    paths:
      - 'src/**'
      - 'package.json'
      - 'scripts/build.ts'
      - '.github/workflows/test-npm-package.yml'

jobs:
  test-npm-package:
    name: Test NPM Package (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
        node-version:
          - '20'      # Minimum supported version
          - '22'      # Current LTS
          - 'latest'  # Latest stable

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Fish Shell
        uses: fish-actions/install-fish@v1.2.0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Yarn
        shell: fish {0}
        run: npm install -g yarn@1.22.22

      - name: Install Dependencies
        shell: fish {0}
        run: yarn install

      - name: Build for NPM
        shell: fish {0}
        run: yarn build:npm

      - name: Pack the Package
        shell: fish {0}
        run: npm pack

      - name: Install Package Globally
        shell: fish {0}
        run: |
          set -l package_file (ls fish-lsp-*.tgz | head -n 1)
          echo "Installing package: $package_file"
          npm install -g $package_file

      - name: Verify fish-lsp binary exists
        run: which fish-lsp

      - name: Test - fish-lsp --version
        run: fish-lsp --version

      - name: Test - fish-lsp --help
        run: fish-lsp --help

      - name: Test - fish-lsp info
        run: fish-lsp info

      - name: Test - fish-lsp info --path
        run: fish-lsp info --path

      - name: Test - fish-lsp env
        run: fish-lsp env

      - name: Test - fish-lsp info --time-startup
        run: fish-lsp info --time-startup

      - name: Test - fish-lsp complete
        run: fish-lsp complete

      - name: Test - fish-lsp start --dump
        run: fish-lsp start --dump

      - name: Cleanup - Uninstall Package
        if: always()
        run: npm uninstall -g fish-lsp
