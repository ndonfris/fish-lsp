## Test building and validating release assets across platforms
## Runs `yarn sh:build-assets` and tests the standalone binary and npm tarball
name: Test Release Assets

on:
  workflow_dispatch: # Allow manual triggering
  pull_request:
    paths:
      - 'src/**'
      - 'package.json'
      - 'scripts/build.ts'
      - 'scripts/build-assets.fish'
      - '.github/workflows/test-release-assets.yml'

jobs:
  test-release-assets:
    name: Test Release Assets (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
        node-version:
          - '22'      # Current LTS

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Fish Shell (v4.x)
        uses: fish-actions/install-fish@v1.2.0

      - name: Verify Fish Version
        shell: fish {0}
        run: |
          echo "Fish version:"
          fish --version

      - name: Set up Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Verify Node Version
        run: node --version

      - name: Install Yarn 1.22.22
        shell: fish {0}
        run: npm install -g yarn@1.22.22

      - name: Verify Yarn Version
        shell: fish {0}
        run: yarn --version

      - name: Install Dependencies
        shell: fish {0}
        run: yarn install

      - name: Build Release Assets
        shell: fish {0}
        run: yarn sh:build-assets

      - name: Show Generated Files in release-assets/
        run: |
          echo "=== Files generated by yarn sh:build-assets ==="
          ls -lh release-assets/
          echo ""
          echo "=== File tree ==="
          find release-assets -type f -exec ls -lh {} \;

      - name: Verify Required Files Exist
        run: |
          echo "=== Verifying required files ==="
          test -f release-assets/fish-lsp.universal && echo "✓ fish-lsp.universal exists"
          test -f release-assets/fish-lsp.tgz && echo "✓ fish-lsp.tgz exists"
          test -f release-assets/fish-lsp.1 && echo "✓ fish-lsp.1 (man page) exists"
          test -f release-assets/fish-lsp.fish && echo "✓ fish-lsp.fish (completions) exists"

      - name: Test Fish Completions Syntax
        shell: fish {0}
        run: |
          echo "=== Testing fish-lsp.fish completions syntax ==="
          fish --no-execute release-assets/fish-lsp.fish && echo "✓ No syntax errors in release-assets/fish-lsp.fish" || echo "✗ Syntax errors found in release-assets/fish-lsp.fish"

      - name: Test fish-lsp.universal Binary
        shell: fish {0}
        run: |
          echo "=== Testing fish-lsp.universal binary ==="
          chmod +x release-assets/fish-lsp.universal
          echo "Testing: fish-lsp.universal --help"
          ./release-assets/fish-lsp.universal --help && echo "✓ --help passed" || echo "✗ --help failed"
          echo ""
          echo "Testing: fish-lsp.universal info"
          ./release-assets/fish-lsp.universal info && echo "✓ info passed" || echo "✗ info failed"
          echo ""
          echo "Testing: fish-lsp.universal info --time-startup"
          ./release-assets/fish-lsp.universal info --time-startup && echo "✓ info --time-startup passed" || echo "✗ info --time-startup failed"
          echo ""
          echo "Testing: fish-lsp.universal start --dump"
          ./release-assets/fish-lsp.universal start --dump && echo "✓ start --dump passed" || echo "✗ start --dump failed"
          echo ""
          echo "✓ All fish-lsp.universal tests completed"

      - name: Get Package Version
        id: version
        shell: fish {0}
        run: |
          set -l version (npm pkg get version | string unescape)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Package version: $version"

      - name: Verify Versioned Tarball Exists
        shell: fish {0}
        run: |
          set -l version (npm pkg get version | string unescape)
          set -l tarball "release-assets/fish-lsp-$version.tgz"
          echo "=== Checking for versioned tarball ==="
          echo "Expected: $tarball"
          if test -f $tarball
            echo "✓ Versioned tarball exists: $tarball"
          else
            echo "✗ Versioned tarball not found: $tarball"
            echo "Files in release-assets:"
            ls -la release-assets/
            exit 1
          end

      - name: Test NPM Tarball Installation
        shell: fish {0}
        run: |
          set -l version (npm pkg get version | string unescape)
          set -l tarball "release-assets/fish-lsp-$version.tgz"
          echo "=== Testing npm tarball installation ==="
          echo "Installing: $tarball"
          npm un -g fish-lsp 2>/dev/null || true
          npm i -g $tarball && echo "✓ npm install succeeded" || echo "✗ npm install failed"
          echo ""
          echo "=== Running fish-lsp tests ==="
          echo "Test: fish-lsp --version"
          fish-lsp --version && echo "✓ --version passed" || echo "✗ --version failed"
          echo ""
          echo "Test: fish-lsp --help"
          fish-lsp --help && echo "✓ --help passed" || echo "✗ --help failed"
          echo ""
          echo "Test: fish-lsp info"
          fish-lsp info && echo "✓ info passed" || echo "✗ info failed"
          echo ""
          echo "Test: fish-lsp info --path"
          fish-lsp info --path && echo "✓ info --path passed" || echo "✗ info --path failed"
          echo ""
          echo "Test: fish-lsp env"
          fish-lsp env && echo "✓ env passed" || echo "✗ env failed"
          echo ""
          echo "Test: fish-lsp info --time-startup"
          fish-lsp info --time-startup && echo "✓ info --time-startup passed" || echo "✗ info --time-startup failed"
          echo ""
          echo "Test: fish-lsp complete"
          fish-lsp complete && echo "✓ complete passed" || echo "✗ complete failed"
          echo ""
          echo "Test: fish-lsp start --dump"
          fish-lsp start --dump && echo "✓ start --dump passed" || echo "✗ start --dump failed"
          echo ""
          echo "✓ All tarball installation tests completed"

      - name: Install Man Page Linter (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y groff

      - name: Validate Man Page
        run: |
          echo "=== Validating man page with groff ==="
          # Check for errors using groff
          groff -man -z release-assets/fish-lsp.1 2>&1 | tee /dev/stderr | if grep -i "error"; then echo "✗ Man page has errors"; exit 1; else echo "✓ No errors in man page"; fi
          echo ""
          echo "=== Man page preview (first 30 lines) ==="
          man -l release-assets/fish-lsp.1 2>/dev/null | head -n 30 && echo "✓ Man page rendered successfully" || echo "✗ Man command not available"

      - name: Test Fish Completions Work
        shell: fish {0}
        run: |
          echo "=== Testing fish completions functionality ==="
          fish -c "source release-assets/fish-lsp.fish; complete -C 'fish-lsp '" | head -n 10 && echo "✓ Fish completions loaded successfully" || echo "✗ Fish completions failed to load"

      - name: Upload Release Assets as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.os }}-node${{ matrix.node-version }}
          path: release-assets/
          retention-days: 7
          if-no-files-found: error

      - name: Cleanup - Uninstall Package
        if: always()
        run: npm uninstall -g fish-lsp || true
